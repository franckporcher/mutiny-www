#!/bin/bash
#
# modules/cgm/install_module.post.sh module_name module_dir
#
# PROJECT: MUTINY Tahiti's websites
#
# Installing the global Perl environment necessary for all cgm
# related activities, scripts and web frontal applications.
#
# Copyright (C) 2015 - Franck Porcher, Ph.D 
# www.franckys.com
# Tous droits réservés
# All rights reserved

#----------------------------------------
# BEGIN
#----------------------------------------
cd "$(dirname "$0")"
SCRIPTNAME="$(basename "$0")"
SCRIPTFQN="$(pwd)/$SCRIPTNAME"
source "$UTILS"

#----------------------------------------
# Perl & Bash environment
#----------------------------------------

${DO} main "$@"
function install_perl_environment () {
    local module_name="$1"
    local module_dir="$2"
    local envd="${module_dir}/env"

    # GENERAL ENV FOR PERL MODULES
    # ----------------------------
    # module_dir/
    #           env/
    #               plenv/
	#				dot.bashrc
    #
	if ! cd "${module_dir}"
	then
		echo "[$SCRIPTNAME] Cannot cd:[$module_dir]" 1>&2
		exit 1
	fi

    # 0. INIT PERL PRIVATE CORRECT ENV
    [ ! -d "${envd}"  ] && mkdir -p "${envd}"

    {
        cat <<-'EOT'

        # CLEAN PERL-ENV CONTEXT
        local perlvars plvar
        perlvars="$(env | grep -E '^PERL' | cut -d '=' -f 1)"
        for plvar in $perlvars
        do
            unset $plvar
        done

        PATH='/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin'
        export PATH
EOT
    } > "${envd}/dot.bashrc"


    # I. PLENV 
    # /!\ => we are in module_dir
    # --------
    ${DO} ${GIT} clone git://github.com/tokuhirom/plenv.git "${envd}/plenv"
    echo "PATH=\"${envd}/plenv/bin:\$PATH\";            "   >> "${envd}/dot.bashrc"
    echo "PLENV_ROOT=\"${envd}/plenv\"; export PLENV_ROOT"  >> "${envd}/dot.bashrc"

    PATH="/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin"
    PATH="${envd}/plenv/bin:$PATH"
    PLENV_ROOT="${envd}/plenv";
    export PATH PLENV_ROOT

    echo 'eval "$(plenv init -)"' >> "${envd}/dot.bashrc"
    eval "$(plenv init -)"

    # 2. CLEAR PERL ENVIRONMENT FOR A CLEAN BUILT
    local x v
    x="$(env | grep -E '^PERL' | cut -d '=' -f 1)"
    for v in $x
    do
        unset $v
    done
    
    # 3. INSTALLING PERL-BUILD
    ${DO} ${GIT} clone git://github.com/tokuhirom/Perl-Build.git "${envd}/plenv/plugins/perl-build/"
    ${DO} plenv rehash

    # 4. INSTALLING Perl 5.20.1
    ${DO} plenv install 5.20.1
    ${DO} plenv rehash # Rebuild the shim executables
    
    # Set the global Perl version
    ${DO} plenv global 5.20.1
    
    # 5. INSTALLING CPANMINUS INTO THE CURRENT GLOBAL PERL
	${DO} plenv install-cpanm
    
    # 6. INSTALLING CARTON
    ${DO} cpanm Carton
    
    # 7. INSTALLING LOCAL::LIB for Carton
	${DO} cpanm --local-lib="${module_dir}/local" local::lib
	local perlstuff="$( ${DO} perl -I local/lib/perl5/ -Mlocal::lib=local )"
    eval  "${perlstuff}"
    echo "${perlstuff}" >> "${envd}/dot.bashrc"
    
    # 8. DISTRO DEPLOYMENT (in module dir)
    ${DO} cd "${module_dir}"
    ${DO} ${TAR} xzf carton.deploy.tgz 
    # Check get cpanfile and cpanfile.snapshot
    ${DO} carton install --cached --deployment --path=./local 2>&1  | tee carton.deploy.log
    
    # carton list
    # which perl
    # perl -V
    # sudo -E -S -g _www -u _www env
}


#----------------------------------------
# Perl Plack local web server for CGM
#----------------------------------------
function install_perl_wwwserver () {
    local module_name="$1"
    local module_dir="$2"

    logtrace "[$SCRIPTNAME] Installing Local Perl Web server"
    ${DO} pushd "$module_dir"

    cat <<-EOT > runplack-operational.sh.conf
# Generated by auto-intaller. Please do not modify manually !
PLACK_HOST='${WWWPERL_SERVER_IP}'
PLACK_PORT='${WWWPERL_SERVER_PORT}'
export PLACK_HOST PLACK_PORT

EOT

    # Launch the server
    nohup ./runplack-operational.sh &
    ${DO} popd
}


#----------------------------------------
# main
#----------------------------------------
function main() {
    # Install the submodules
    local module_name="$1"
    local module_dir="$2"

    #install_perl_environment
    pushd .
    if cd "${module_dir}"
    then
        ${DO} install_perl_environment "${module_name}" "${module_dir}"
        $APACHECTL -k graceful
    else
        logtrace "[$SCRIPTNAME] Cannot cd:[$module_dir]"
        return 1
    fi

    # Installing perl server
    install_perl_wwwserver "${module_name}" "${module_dir}"

}

${DO} main "$@"
